<html>
<head>
	<script type="application/javascript">
		var canvas, context;
		var size = 600;
		var height = size, width = size;
		var center = [Math.floor(width/2), Math.floor(height/2)];
		var pixelSize = 2;
		var wavelength = 50;
		var period = 20;
		var momentsCount = 10000;
		var sources;
		var startTime = 0, curTime = startTime;
		var diff = 0;
		var radius = 4;
		var step = 1;
		var S;
		var sourcesCount = 13;

		var running = true;

		function init() {
			canvas = document.getElementById('canvas');
			context = canvas.getContext('2d');
			canvas.width = width;
			canvas.height = height;

			context.fillStyle="white";
			context.fillRect(0,0,width,height);

			sources = createSources(sourcesCount);

			S = calculateSinuses(period, momentsCount);
			D = calculateDistances(sources);

			image = context.getImageData(0, 0, width, height);
			run();
		}

		function createSources (sourcesCount) {
			var s = new Array(sourcesCount);
			var R = size/4, alpha;

			for (var i = sourcesCount-1; i>=0; --i) {
				alpha = 2*Math.PI*i/sourcesCount;
				s[i] = new Array(2);
				s[i][0] = center[0] + Math.round(R*Math.sin(alpha));
				s[i][1] = center[1] - Math.round(R*Math.cos(alpha));
			}
			return s;
		}

		function drawSources (sources, radius) {
			var pixels = image.data;
			for (var i = sources.length - 1; i >= 0; i--) {
				index = 4*(width*sources[i][1] + sources[i][0] - radius);
				for (var j = 4*(2*radius-1); j>=0; j -= 4) {
					pixels[index + j] = 255.0;
			        pixels[index + j + 1] = 0;
			        pixels[index + j + 2] = 0;
			        pixels[index + j + 3] = pixels[index + j + 3];
				}

				index = 4*(width*(sources[i][1] - radius) + sources[i][0]);
				for (var j = 4*width*(2*radius-1); j>=0; j -= 4*width) {
					pixels[index + j] = 255.0;
			        pixels[index + j + 1] = 0;
			        pixels[index + j + 2] = 0;
			        pixels[index + j + 3] = pixels[index + j + 3];
				}
	    	}
		}

		function run() {
		    var pixels = image.data;

    		var shift = (curTime-startTime)%period/period*momentsCount;
			var index = 0, d, moment;
		    for (var y = height - 1; y >= 0; y--) {		
				for (var x = width - 1; x >= 0; x--) {
					var val = 0.0;
	    			for (var i = sources.length - 1; i >= 0; i--) {
	    				d = D[y][x][i];
	    				moment = Math.round(d - Math.floor(d/period)*period)/period*momentsCount;
				    	val += S[(moment - shift + momentsCount)%momentsCount];
			    	}

			    	val *= Math.round((255.0-diff)/(2*sources.length));

			    	pixels[index] = val;
			        pixels[index + 1] = val;
			        pixels[index + 2] = val;
			        pixels[index + 3] = pixels[index + 3];
			        index += 4;
				}
			} 
			drawSources(sources, radius);		 
		    context.putImageData(image, 0, 0);  
	    	curTime += step;
			requestAnimationFrame(run);
	    }

	    function changeSources () {
	    	selection = document.getElementById('select')[0].value;
	    	if (selection == 1)
	    		sources = [[height/2, width/4]];
	    	else if (selection == 2)
	    		sources = [[height/2, width/4],  [height/2, 3*width/4]];
	    }

		function calculateSinuses(period, momentsCount) {
			S = new Array(momentsCount);
			var arg = 0, step = 2*Math.PI/momentsCount;
			for(var i = momentsCount-1; i>=0; --i, arg += step) {
				S[i] = Math.sin(arg)+1;
			}
			return S;
		}
		function calculateDistances(sources) {
			var D = new Array(height);
			for (var y = height - 1; y >= 0; y--) {					
				D[y] = new Array(width);
				for (var x = width - 1; x >= 0; x--) {
					D[y][x] = new Array(sources.length);
					for (var i = sources.length - 1; i >= 0; i--) {
						D[y][x][i] = distance([x, height-y], sources[i]);
					}
				}				
			}
			return D;
		}

		function distance(a, b) {
			return Math.sqrt((a[0]-b[0])*(a[0]-b[0]) + (a[1]-b[1])*(a[1]-b[1]));
		}
	</script>
	</head>
	<!-- <body> -->
	<body onload="init();">
		<div style="width: 100%">
			<div style="float:left; width: 60%">
				<canvas id="canvas"></canvas>
			</div>
			<div style="float:left">
				<select id="select" onchange="changeSources()">
				  <option value=1> 1 </option> 
				  <option value=2> 2 </option>
				  <option value=3> 3 </option>
				  <option value=4> 4 </option>
				</select>
			</div>
		</div>
	</body>
</html>